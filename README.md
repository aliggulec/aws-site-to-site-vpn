# AWS Site-to-Site VPN with Static Routing

This Terraform configuration creates AWS Site-to-Site VPN connections with static routing between multiple VPCs and external vendors.

## üèóÔ∏è Architecture Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Production    ‚îÇ    ‚îÇ      Alpha      ‚îÇ
‚îÇ      VPC        ‚îÇ    ‚îÇ      VPC        ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Private  ‚îÇ  ‚îÇ    ‚îÇ  ‚îÇ  Private  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Subnets  ‚îÇ  ‚îÇ    ‚îÇ  ‚îÇ  Subnets  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ VPN Gateway‚îÇ         ‚îÇ VPN Gateway‚îÇ
    ‚îÇ (per vendor)‚îÇ        ‚îÇ (per vendor)‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ  Customer   ‚îÇ
              ‚îÇ  Gateway    ‚îÇ
              ‚îÇ (per vendor)‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   Vendor    ‚îÇ
              ‚îÇ Infrastructure‚îÇ
              ‚îÇ (Generic)   ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìÅ File Structure

```
‚îú‚îÄ‚îÄ main.tf              # VPN gateway module configuration
‚îú‚îÄ‚îÄ data.tf              # Data sources for VPC, subnets, route tables
‚îú‚îÄ‚îÄ variables.tf         # Configuration variables
‚îú‚îÄ‚îÄ providers.tf         # Terraform and AWS provider configuration
‚îú‚îÄ‚îÄ outputs.tf           # Resource outputs
‚îú‚îÄ‚îÄ cloudwatch.tf        # CloudWatch log groups for VPN tunnels
‚îú‚îÄ‚îÄ customergateway.tf   # Customer gateway resources
‚îú‚îÄ‚îÄ vpngateway.tf        # VPN gateway resources
‚îú‚îÄ‚îÄ deploy.sh           # Deployment script
‚îî‚îÄ‚îÄ README.md           # This file
```

## ‚ö†Ô∏è Critical Security Considerations

### üîê **1. BGP ASN Configuration**
- **Default**: Using ASN `65001` (private range)
- **Critical**: Ensure ASN doesn't conflict with existing infrastructure
- **Valid Ranges**: 
  - 16-bit: `64512-65534` (private)
  - 32-bit: `4200000000-4294967294` (private)

### üåê **2. IP Address Security**
- **Customer Gateway IP**: `x.x.x.x` (placeholder - **MUST BE CONFIGURED**)
- **Critical**: Replace placeholder with vendor's actual public IP
- **Security**: Ensure IP is whitelisted and verified before deployment

### üîí **3. Static Routes Configuration**
- **Production**: `10.0.0.1/32` (placeholder)
- **Alpha**: `10.0.0.2/32` (placeholder)
- **Dev**: `10.0.0.3/32` (placeholder)
- **Critical**: Replace placeholders with actual destination CIDRs
- **Security**: Use `/32` for host-specific routing (current setup)

### üö® **4. Network CIDR Configuration**
- **Local Network**: `10.0.0.0/8` (vendor side network)
- **‚ö†Ô∏è NOTE**: This is a large network range
- **Recommendation**: Restrict to specific vendor subnets as needed

### üîç **5. CloudWatch Logging**
- **Status**: Enabled for both tunnels
- **Retention**: 90 days
- **Critical**: Monitor for connection issues and security events

## üéØ Pre-Deployment Checklist

### ‚úÖ **AWS Prerequisites**
- [ ] AWS CLI configured with appropriate permissions
- [ ] Terraform >= 1.0 installed
- [ ] VPCs exist with proper tags (configure in variables.tf):
  - Production VPC name configured
  - Alpha VPC name configured
- [ ] Private subnets exist with naming pattern (configure in variables.tf):
  - Production subnet filter configured
  - Alpha subnet filter configured

### ‚úÖ **Network Prerequisites**
- [ ] **CRITICAL**: Configure vendor IP address in variables.tf (replace `x.x.x.x`)
- [ ] **CRITICAL**: Configure destination CIDRs in variables.tf:
  - Production route target
  - Alpha route target
  - Dev route target (if applicable)
- [ ] BGP ASN `65001` doesn't conflict with existing setup
- [ ] **CRITICAL**: Configure VPC remote CIDR blocks in variables.tf

### ‚úÖ **Security Prerequisites**
- [ ] VPN pre-shared keys ready (will be generated by AWS)
- [ ] Vendor network team notified of AWS public IPs (available post-deployment)
- [ ] Firewall rules configured for IPSec traffic (UDP 500, 4500)

## ‚öôÔ∏è Configuration Setup

**‚ö†Ô∏è CRITICAL**: Before deployment, you MUST configure the following in `variables.tf`:

### 1. VPC Configuration
```hcl
vpc_configs = {
  production = {
    vpc_name           = "your-production-vpc-name"  # Replace with actual VPC name tag
    subnet_name_filter = "*production-private*"     # Replace with actual subnet filter
    remote_cidr        = "10.0.0.5/16"             # Aws VPC CIDR
  }
  alpha = {
    vpc_name           = "your-alpha-vpc-name"       # Replace with actual VPC name tag
    subnet_name_filter = "*alpha-private*"          # Replace with actual subnet filter  
    remote_cidr        = "10.0.0.5/16"             # Aws VPC CIDR
  }
}
```

### 2. Vendor Configuration
```hcl
vendor_configs = {
  vendor1 = {
    bgp_asn            = 65001                      # Ensure no conflicts
    ip_address         = "YOUR.VENDOR.IP.ADDRESS"  # Replace with vendor's public IP
    local_network_cidr = "10.0.0.0/8"             # Replace with vendor's network CIDR
    static_routes = {
      production = "10.0.0.1/32"                   # Replace with actual destination
      alpha      = "10.0.0.2/32"                   # Replace with actual destination
      dev        = "10.0.0.3/32"                   # Replace with actual destination
    }
  }
}
```

## üöÄ Quick Deployment

### Option 1: Manual Configuration and Deployment
```bash
# 1. Configure variables.tf with your actual values
# 2. Initialize Terraform
terraform init

# 3. Plan deployment (review carefully!)
terraform plan -out=vpn.tfplan

# 4. Apply changes
terraform apply vpn.tfplan

# 5. Get VPN connection details
terraform output
```

## üìä Post-Deployment Verification

### 1. Check VPN Connection Status
```bash
aws ec2 describe-vpn-connections --query 'VpnConnections[*].[VpnConnectionId,State]' --output table
```

### 2. Monitor CloudWatch Logs
```bash
aws logs describe-log-groups --log-group-name-prefix "/aws/vpn"
```

### 3. Verify Route Propagation
```bash
aws ec2 describe-route-tables --filters "Name=tag:Name,Values=*private*" --query 'RouteTables[*].Routes'
```

## üîß Configuration Customization

### Adding New Vendor
Edit `variables.tf` and add to `vendor_configs`:

```hcl
vendor2 = {
  bgp_asn            = 65002                    # Use unique ASN
  ip_address         = "vendor2.public.ip"     # Vendor's public IP
  local_network_cidr = "192.168.0.0/16"       # Vendor's network CIDR
  static_routes = {
    production = "192.168.1.1/32"             # Vendor2 production target
    alpha      = "192.168.1.2/32"             # Vendor2 alpha target
    dev        = "192.168.1.3/32"             # Vendor2 dev target
  }
}
```

### Adding New Environment
Edit `variables.tf` and add to `vpc_configs`:

```hcl
staging = {
  vpc_name           = "your-staging-vpc-name"   # Actual staging VPC name
  subnet_name_filter = "*staging-private*"      # Staging subnet filter
  remote_cidr        = "10.0.0.5/16"           # Aws VPC CIDR
```

**Note**: When adding new environments, ensure corresponding routes exist in vendor static_routes configuration.

## üìã Outputs

After deployment, you'll receive:
- **VPN Gateway IDs**: For each VPC-vendor combination
- **Customer Gateway IDs**: For each vendor
- **VPN Connection IDs**: For monitoring and management
- **CloudWatch Log Group ARNs**: For logging access

## üõ†Ô∏è Troubleshooting

### Common Issues

1. **Configuration Not Set**
   - **Error**: Empty values in variables.tf
   - **Solution**: Replace all placeholder values (`""`, `x.x.x.x`) with actual configuration

2. **VPC Not Found**
   - Verify VPC exists and has correct `Name` tag in variables.tf
   - Check AWS region configuration

3. **Subnet Not Found**
   - Verify subnet naming pattern matches filter in variables.tf
   - Ensure subnets are in the correct VPC

4. **Invalid IP Address**
   - **Error**: Customer gateway IP is `x.x.x.x`
   - **Solution**: Replace with vendor's actual public IP address

5. **Module Installation Error**
   - Run `terraform init` to download required modules
   - Check internet connectivity

6. **Permission Denied**
   - Verify AWS credentials have VPN management permissions
   - Check IAM policies for EC2 and VPC access

### Emergency Commands

```bash
# Emergency: Destroy all VPN infrastructure
terraform destroy -auto-approve

# Emergency: Disconnect specific VPN
aws ec2 delete-vpn-connection --vpn-connection-id vpn-xxxxxxxxx
```

## üìû Support Contacts

- **AWS Support**: For AWS-related issues
- **Vendor Network Team**: For vendor-side connectivity
- **Internal DevOps**: For infrastructure modifications

## üîê Security Notes

1. **Never commit sensitive data** (keys, passwords) to version control
2. **Monitor CloudWatch logs** for suspicious activity
3. **Regularly review** route tables and security groups
4. **Keep Terraform state secure** - consider remote state with encryption
5. **Document all changes** in change management system

---

**‚ö†Ô∏è Important**: Always test in non-production environment first!
